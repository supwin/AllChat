<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Platform Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Styles for Assistant */
        #assistant-bubble { position: fixed; bottom: 20px; right: 20px; z-index: 9998; }
        #assistant-container { position: fixed; bottom: 90px; right: 20px; width: 375px; height: 500px; z-index: 9999; transition: opacity 0.3s, transform 0.3s; transform: translateY(20px); opacity: 0; pointer-events: none; }
        #assistant-container.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        #assistant-chat-log::-webkit-scrollbar { width: 4px; }
        #assistant-chat-log::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 20px; }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            
            <h1 class="text-xl md:text-2xl font-bold text-gray-900">
                ยินดีต้อนรับ, <span id="tenant-name">ลูกค้า</span>!
            </h1>

            <div class="flex items-center gap-4">
                <div id="tenant-id-display" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></div>
                <img src="/static/images/salee-mascot-small.png" alt="Salee Mascot" class="h-10 w-auto hidden sm:block">
                <button id="logout-button" class="text-sm font-medium text-gray-600 hover:text-red-500 transition-colors">
                    <i class="fas fa-sign-out-alt mr-1"></i>ออกจากระบบ
                </button>
            </div>

        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        
        <!-- Business Type Display and Initial Setup Prompt -->
        <div id="business-type-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-2">ประเภทธุรกิจของคุณ: <span id="display-business-type" class="text-blue-600">กำลังโหลด...</span></h2>
            <p id="business-type-description" class="text-gray-600 mb-4">
                คุณยังไม่ได้ระบุประเภทธุรกิจ กรุณาตั้งค่าเพื่อปรับแต่ง Dashboard และ Chatbot ของคุณ
            </p>
            <button id="setup-business-type-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 hidden">ตั้งค่าประเภทธุรกิจ</button>
        </div>

        <!-- Dynamic Dashboard Content -->
        <div id="dynamic-dashboard-content">
            <div class="bg-gray-200 p-8 rounded-lg shadow-lg text-center text-gray-700">
                <p>กำลังโหลดข้อมูล Dashboard...</p>
            </div>
        </div>

        <!-- Channels Section -->
        <div id="channels" class="mb-8 mt-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">เชื่อมต่อช่องทางของคุณ (Channels)</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <!-- LINE Card -->
                <a href="#" id="link-to-line-guide" class="block p-6 bg-white rounded-lg shadow hover:shadow-xl transition-shadow">
                    <div class="flex items-center">
                        <i class="fab fa-line text-4xl text-green-500"></i>
                        <h4 class="text-lg font-bold ml-4">LINE Messenger</h4>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">เชื่อมต่อบอทของคุณกับ LINE Official Account</p>
                </a>
                <!-- Facebook Card -->
                <a href="#" id="link-to-facebook-guide" class="block p-6 bg-white rounded-lg shadow hover:shadow-xl transition-shadow">
                    <div class="flex items-center">
                        <i class="fab fa-facebook-messenger text-4xl text-blue-600"></i>
                        <h4 class="text-lg font-bold ml-4">Facebook Messenger</h4>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">เชื่อมต่อกับเพจ Facebook ของคุณ</p>
                </a>
                <!-- Website Widget Card -->
                <a href="#" id="link-to-settings-2" class="block p-6 bg-white rounded-lg shadow hover:shadow-xl transition-shadow">
                     <div class="flex items-center">
                        <i class="fas fa-window-maximize text-4xl text-indigo-500"></i>
                        <h4 class="text-lg font-bold ml-4">วิดเจ็ตบนเว็บไซต์</h4>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">นำโค้ดไปติดตั้งบนเว็บไซต์ของคุณ</p>
                </a>
            </div>
        </div>

        <!-- Management Section -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">การจัดการ (Management)</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <!-- NEW: Inbox Card -->
                <a href="#" id="link-to-inbox" class="block p-6 bg-white rounded-lg shadow hover:shadow-xl transition-shadow">
                    <div class="flex items-center">
                        <i class="fas fa-inbox text-4xl text-blue-500"></i>
                        <h4 class="text-lg font-bold ml-4">กล่องข้อความ (Inbox)</h4>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">ดูและตอบกลับบทสนทนาจากลูกค้าของคุณในที่เดียว</p>
                </a>
                <!-- Bot Settings Card -->
                <a href="#" id="link-to-settings-3" class="block p-6 bg-white rounded-lg shadow hover:shadow-xl transition-shadow">
                    <div class="flex items-center">
                        <i class="fas fa-brain text-4xl text-purple-500"></i>
                        <h4 class="text-lg font-bold ml-4">ตั้งค่าสมองบอท</h4>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">แก้ไขบทบาท, ฐานความรู้, และการเชื่อมต่อทั้งหมด</p>
                </a>
                <!-- Analytics Card (Coming Soon) -->
                <div class="p-6 bg-gray-200 rounded-lg shadow relative">
                     <span class="absolute top-2 right-2 bg-yellow-400 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full">เร็วๆ นี้</span>
                    <div class="flex items-center opacity-50">
                        <i class="fas fa-chart-line text-4xl text-gray-500"></i>
                        <h4 class="text-lg font-bold ml-4">สถิติการใช้งาน</h4>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">ดูข้อมูลเชิงลึกว่าบอทของคุณทำงานได้ดีแค่ไหน</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Settings Assistant Chat Bubble & Container -->
    <button id="assistant-bubble" class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-purple-700 transition-transform transform hover:scale-110">
        <i class="fas fa-hands-helping text-2xl"></i>
    </button>
    <div id="assistant-container" class="bg-white rounded-2xl shadow-2xl flex flex-col">
        <div class="p-4 bg-purple-600 text-white flex items-center shadow-md rounded-t-2xl"><h1 class="text-lg font-bold">ผู้ช่วยจัดการ</h1></div>
        <div id="assistant-chat-log" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <form id="assistant-form" class="p-4 border-t flex items-center bg-white rounded-b-2xl">
            <input type="text" id="assistant-input" placeholder="บอกให้เราช่วย..." class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button type="submit" class="ml-3 bg-purple-600 text-white rounded-full p-2 hover:bg-purple-700"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { firebaseConfig } from '/static/firebase-config.js'; 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let app, db, auth;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const TENANT_ID = urlParams.get('tenant_id');

            if (!TENANT_ID) {
                document.body.innerHTML = '<div class="w-full h-screen flex items-center justify-center"><h1>Error: Tenant ID not found.</h1></div>';
                return;
            }

            // --- Firebase Initialization ---
            if (firebaseConfig && firebaseConfig.apiKey) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase initialized successfully.");
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    // Handle UI error display
                    return;
                }
            } else {
                console.error("Firebase config is missing or invalid.");
                // Handle UI error display
                return;
            }

            // --- Auth State Change Listener ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User authenticated:", user.uid);
                    fetchTenantData(TENANT_ID, user.uid);
                } else {
                    console.warn("User not authenticated.");
                    // Handle UI for non-authenticated user
                }
            });

            // --- Main Dashboard Logic ---
            document.getElementById('tenant-id-display').textContent = `รหัสผู้ใช้งาน: ${TENANT_ID}`;
            
            // Setup navigation links
            const settingsUrl = `/settings?tenant_id=${TENANT_ID}`;
            const inboxUrl = `/inbox?tenant_id=${TENANT_ID}`;
            
            document.getElementById('link-to-settings-2').href = settingsUrl;
            document.getElementById('link-to-settings-3').href = settingsUrl;
            document.getElementById('link-to-inbox').href = inboxUrl;
            document.getElementById('link-to-line-guide').href = `/line-setup-guide?tenant_id=${TENANT_ID}`;
            document.getElementById('link-to-facebook-guide').href = `/facebook-setup-guide?tenant_id=${TENANT_ID}`;
            
            async function fetchTenantData(tenantId, uid) {
                try {
                    const response = await fetch(`/api/tenant/${tenantId}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    if (data.owner_uid !== uid) {
                        console.error("Access Denied: User is not the owner.");
                        // Handle UI for access denied
                        document.body.innerHTML = `<div class="w-full h-screen flex items-center justify-center text-center"><div><h1 class="text-3xl font-bold text-red-500">Access Denied</h1><p class="text-gray-600">คุณไม่มีสิทธิ์เข้าถึงข้อมูลส่วนนี้</p><a href="/login" class="text-blue-500 hover:underline mt-4 inline-block">กลับไปหน้าล็อกอิน</a></div></div>`;
                        return;
                    }

                    document.getElementById('tenant-name').textContent = data.tenantName || 'ลูกค้า';
                    const businessType = data.businessType;
                    
                    const displayBusinessTypeEl = document.getElementById('display-business-type');
                    const businessTypeDescriptionEl = document.getElementById('business-type-description');
                    const setupBusinessTypeBtnEl = document.getElementById('setup-business-type-btn');

                    if (businessType) {
                        displayBusinessTypeEl.textContent = getBusinessTypeName(businessType);
                        businessTypeDescriptionEl.textContent = 'Dashboard ของคุณถูกปรับแต่งตามประเภทธุรกิจนี้แล้ว';
                        setupBusinessTypeBtnEl.classList.add('hidden');
                        renderDynamicDashboard(businessType, settingsUrl);
                    } else {
                        displayBusinessTypeEl.textContent = 'ยังไม่ระบุ';
                        businessTypeDescriptionEl.textContent = 'กรุณาตั้งค่าประเภทธุรกิจของคุณเพื่อปรับแต่ง Dashboard และ Chatbot ของคุณ';
                        setupBusinessTypeBtnEl.classList.remove('hidden');
                        setupBusinessTypeBtnEl.textContent = 'ตั้งค่าประเภทธุรกิจ';
                        setupBusinessTypeBtnEl.onclick = () => window.location.href = settingsUrl;
                        renderDynamicDashboard('default', settingsUrl);
                    }
                } catch (err) {
                    console.error("Could not fetch tenant data:", err);
                    // Handle UI for fetch error
                }
            }

            function getBusinessTypeName(type) {
                const types = {
                    'physical_products_single': 'ขายสินค้า (ตัวเดียว/ไม่กี่ชนิด)',
                    'physical_products_multi': 'ขายสินค้า (หลากหลายประเภท)',
                    'service_appointment': 'ขายบริการ (นัดหมาย/จองคิว)',
                    'service_project': 'ขายบริการ (โปรเจกต์/กำหนดเอง)',
                    'other_specialized': 'ธุรกิจเฉพาะทางอื่นๆ'
                };
                return types[type] || 'ไม่ระบุ';
            }

            function renderDynamicDashboard(type, settingsUrl) {
                const dynamicDashboardContent = document.getElementById('dynamic-dashboard-content');
                let contentHtml = '';
                // Logic for rendering different dashboards based on type...
                // (The existing complex switch-case logic can remain here)
                // For brevity, I'll put a placeholder here.
                // You should keep your original switch-case block.
                contentHtml = `
                    <div class="bg-blue-600 text-white p-8 rounded-lg shadow-lg mb-8">
                        <h2 class="text-3xl font-bold mb-2">เริ่มต้นใช้งาน</h2>
                        <p class="mb-4">ทำตามขั้นตอนง่ายๆ เพื่อให้บอทของคุณพร้อมทำงานในไม่กี่นาที</p>
                        <ol class="list-decimal list-inside space-y-2">
                            <li><a href="${settingsUrl}" class="hover:underline font-semibold">ตั้งค่า "สมอง" ของบอท</a> - กำหนดบทบาทและฐานความรู้</li>
                            <li><a href="#channels" class="hover:underline font-semibold">เชื่อมต่อช่องทางแชท</a> - เลือก LINE, Facebook, หรือเว็บไซต์</li>
                            <li>นำบอทไปใช้งานจริง!</li>
                        </ol>
                    </div>`;
                dynamicDashboardContent.innerHTML = contentHtml;
            }

            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', () => {
                signOut(auth).then(() => {
                    console.log('User signed out successfully.');
                    window.location.href = '/login'; // กลับไปหน้า Login
                }).catch((error) => {
                    console.error('Sign out error:', error);
                });
            });
            // --- Assistant Chat Logic ---
            // (The existing assistant logic can remain here)
        });


    </script>
</body>
</html>
