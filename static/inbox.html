<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Inbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 20px; }
        .user-list-item.selected { background-color: #e0f2fe; }
        .toggle-checkbox:checked { right: 0; border-color: #16a34a; }
        .toggle-checkbox:checked + .toggle-label { background-color: #16a34a; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <a href="#" id="back-to-dashboard" class="text-sm text-blue-600 hover:underline">&larr; กลับไปหน้าหลัก</a>
            <h1 class="text-2xl font-bold text-gray-900 mt-1">กล่องข้อความ (Inbox)</h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="flex h-[75vh] bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- User List Panel -->
            <div id="user-list-panel" class="w-full md:w-1/3 border-r border-gray-200 flex flex-col">
                <div class="p-4 border-b">
                    <h3 class="font-semibold text-gray-800">บทสนทนาทั้งหมด</h3>
                </div>
                <div id="user-list-container" class="overflow-y-auto flex-1">
                    <p class="p-4 text-gray-500" id="user-list-loading">กำลังตรวจสอบสิทธิ์การเข้าถึง...</p>
                </div>
            </div>

            <!-- Chat Panel -->
            <div id="chat-panel" class="w-full md:w-2/3 flex-col hidden">
                <!-- ✨ REVISED: Chat Header with Correct Layout -->
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <!-- Left Side: User Info -->
                    <div class="flex items-center gap-3">
                        <img id="chat-header-avatar" src="" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <h3 id="chat-header-user-name" class="font-semibold text-gray-800"></h3>
                            <p id="chat-header-user-id" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <!-- Right Side: Controls (Grouped Together) -->
                    <div class="flex items-center gap-4">
                        <div id="lead-score-display" class="text-sm font-medium text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full"></div>
                        <div id="gemini-tools-container" class="hidden">
                             <button id="summarize-btn" class="bg-purple-100 text-purple-700 hover:bg-purple-200 text-sm font-semibold py-2 px-3 rounded-lg flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                                สรุป
                            </button>
                        </div>
                        <div class="flex items-center">
                            <span id="bot-status-text" class="text-sm mr-2 font-medium text-gray-600">Bot: OFF</span>
                             <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle-bot" id="toggle-bot-checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="toggle-bot-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat History -->
                <div id="chat-history-container" class="flex-1 overflow-y-auto p-6 space-y-4 chat-container">
                    <!-- Messages will be loaded here -->
                </div>

                <!-- Reply Form -->
                <div class="p-4 border-t bg-gray-50">
                    <form id="admin-reply-form" class="flex items-center gap-2">
                        <input type="text" id="admin-message-input" placeholder="พิมพ์ข้อความในฐานะแอดมิน..." class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off" required>
                        <button id="draft-reply-btn" type="button" class="p-2 text-purple-600 hover:text-purple-800 flex-shrink-0" title="✨ ร่างคำตอบจากคีย์เวิร์ด">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                        </button>
                        <button type="submit" class="bg-blue-600 text-white rounded-full px-5 py-2 hover:bg-blue-700 font-semibold flex-shrink-0">ส่ง</button>
                    </form>
                </div>
            </div>

            <!-- Placeholder Panel -->
            <div id="placeholder-panel" class="w-full md:w-2/3 flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                    <i class="fas fa-comments text-5xl text-gray-300 mb-4"></i>
                    <p>กรุณาเลือกบทสนทนาจากด้านซ้าย</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Summary Modal -->
    <div id="summary-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 class="text-xl font-bold text-gray-900">✨ สรุปบทสนทนา</h3>
                <button id="close-modal-btn" class="text-2xl font-bold leading-none text-gray-600 hover:text-gray-900">&times;</button>
            </div>
            <div id="summary-content" class="mt-4 p-4 bg-gray-50 rounded-lg min-h-[200px]"></div>
        </div>
    </div>

    <script type="module">
        import { firebaseConfig } from '/static/firebase-config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const userListContainer = document.getElementById('user-list-container');
        const userListLoading = document.getElementById('user-list-loading');
        const chatPanel = document.getElementById('chat-panel');
        const placeholderPanel = document.getElementById('placeholder-panel');
        const chatHeaderAvatar = document.getElementById('chat-header-avatar');
        const chatHeaderUserName = document.getElementById('chat-header-user-name');
        const chatHeaderUserId = document.getElementById('chat-header-user-id');
        const leadScoreDisplay = document.getElementById('lead-score-display');
        const chatHistoryContainer = document.getElementById('chat-history-container');
        const adminReplyForm = document.getElementById('admin-reply-form');
        const adminMessageInput = document.getElementById('admin-message-input');
        const backToDashboardLink = document.getElementById('back-to-dashboard');
        const botStatusText = document.getElementById('bot-status-text');
        const botToggleCheckbox = document.getElementById('toggle-bot-checkbox');
        const geminiToolsContainer = document.getElementById('gemini-tools-container');

        // --- State Variables ---
        let db, auth;
        let currentUserId = null;
        let unsubscribeFromChat = null;
        let usersData = {};
        let TENANT_ID;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            TENANT_ID = urlParams.get('tenant_id');

            if (!TENANT_ID) {
                document.body.innerHTML = '<h1>Error: ไม่พบ Tenant ID ใน URL</h1>';
                return;
            }

            backToDashboardLink.href = `/dashboard?tenant_id=${TENANT_ID}`;

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        loadUserList(TENANT_ID);
                    } else {
                        userListLoading.textContent = 'การยืนยันตัวตนล้มเหลว โปรดกลับไปหน้าหลักและเข้าสู่ระบบใหม่อีกครั้ง';
                        userListLoading.classList.add('text-red-500');
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userListContainer.innerHTML = `<p class="p-4 text-red-500">เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}</p>`;
            }
        });

        function updateBotToggleUI(isActive) {
            botToggleCheckbox.checked = isActive;
            botStatusText.textContent = isActive ? 'Bot: ON' : 'Bot: OFF';
            botStatusText.className = `text-sm mr-2 font-medium ${isActive ? 'text-green-600' : 'text-gray-600'}`;
        }

        async function loadUserList(tenantId) {
            userListLoading.textContent = 'กำลังโหลดรายชื่อผู้ใช้...';
            const usersCollectionRef = collection(db, 'chat_sessions', tenantId, 'users');
            onSnapshot(query(usersCollectionRef, orderBy('lastMessageTime', 'desc')), (snapshot) => {
                userListContainer.innerHTML = '';
                if (snapshot.empty) {
                    userListLoading.textContent = 'ยังไม่มีบทสนทนา';
                    userListContainer.appendChild(userListLoading);
                    return;
                }
                snapshot.forEach(doc => {
                    const user = { user_id: doc.id, ...doc.data() };
                    usersData[user.user_id] = user;
                    const userElement = createUserListItem(user);
                    userListContainer.appendChild(userElement);
                });
            }, (error) => {
                console.error("Error loading user list with snapshot:", error);
                userListLoading.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                userListContainer.appendChild(userListLoading);
            });
        }

        function createUserListItem(user) {
            const userDiv = document.createElement('div');
            userDiv.className = 'p-4 flex items-center gap-4 cursor-pointer hover:bg-gray-50 user-list-item';
            userDiv.dataset.userId = user.user_id;
            const avatar = document.createElement('img');
            avatar.src = user.pictureUrl || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=random`;
            avatar.className = 'w-12 h-12 rounded-full object-cover';
            userDiv.appendChild(avatar);
            const textContainer = document.createElement('div');
            textContainer.className = 'flex-1 overflow-hidden';
            const nameDiv = document.createElement('div');
            nameDiv.className = 'font-semibold text-gray-800';
            nameDiv.textContent = user.displayName || 'Unknown User';
            const unreadCount = calculateUnreadCount(user);
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'ml-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full';
                badge.textContent = unreadCount;
                nameDiv.appendChild(badge);
            }
            textContainer.appendChild(nameDiv);
            userDiv.appendChild(textContainer);
            return userDiv;
        }

        userListContainer.addEventListener('click', (e) => {
            const userItem = e.target.closest('.user-list-item');
            if (userItem && userItem.dataset.userId) {
                const tenantId = new URLSearchParams(window.location.search).get('tenant_id');
                const userId = userItem.dataset.userId;
                document.querySelectorAll('.user-list-item').forEach(item => item.classList.remove('selected'));
                userItem.classList.add('selected');
                loadUserChat(tenantId, userId);
            }
        });

        function loadUserChat(tenantId, userId) {
            currentUserId = userId;
            const currentUserData = usersData[userId];
            chatPanel.classList.remove('hidden');
            chatPanel.classList.add('flex');
            placeholderPanel.classList.add('hidden');
            
            geminiToolsContainer.classList.remove('hidden');

            chatHeaderAvatar.src = currentUserData.pictureUrl || `https://ui-avatars.com/api/?name=${currentUserData.displayName || 'U'}&background=random`;
            chatHeaderUserName.textContent = currentUserData.displayName || 'Unknown User';
            chatHeaderUserId.textContent = `ID: ${userId}`;
            fetch(`/api/inbox/${tenantId}/${userId}/mark-as-read`, { method: 'POST' }).catch(err => console.error("Failed to mark as read:", err));
            if (unsubscribeFromChat) unsubscribeFromChat();
            const chatDocRef = doc(db, 'chat_sessions', tenantId, 'users', userId);
            unsubscribeFromChat = onSnapshot(chatDocRef, async (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    displayChatHistory(data);
                    let isBotActive = (data.is_bot_active === undefined) ? true : data.is_bot_active;
                    const history = data.history || [];
                    if (history.length > 0) {
                        const lastMessage = history[history.length - 1];
                        if (lastMessage.timestamp) {
                            const hoursDiff = (new Date() - new Date(lastMessage.timestamp)) / 36e5;
                            if (hoursDiff > 1 && !isBotActive) {
                                await updateDoc(chatDocRef, { is_bot_active: true });
                                isBotActive = true; 
                            }
                        }
                    }
                    updateBotToggleUI(isBotActive);
                } else {
                    chatHistoryContainer.innerHTML = '<p class="text-center text-gray-500">ไม่พบประวัติการแชท</p>';
                    updateBotToggleUI(true);
                }
            }, (error) => {
                console.error("Error listening to chat:", error);
                chatHistoryContainer.innerHTML = `<p class="p-4 text-red-500">เกิดข้อผิดพลาดในการเชื่อมต่อ Real-time</p>`;
            });
        }

        botToggleCheckbox.addEventListener('change', async () => {
            if (!currentUserId || !db) return;
            const chatDocRef = doc(db, 'chat_sessions', TENANT_ID, 'users', currentUserId);
            const newStatus = botToggleCheckbox.checked;
            try {
                await updateDoc(chatDocRef, { is_bot_active: newStatus });
                updateBotToggleUI(newStatus);
            } catch (error) {
                alert('ไม่สามารถอัปเดตสถานะบอทได้: ' + error.message);
                updateBotToggleUI(!newStatus);
            }
        });

        function displayChatHistory(data) {
            chatHistoryContainer.innerHTML = '';
            leadScoreDisplay.textContent = data.lead_score_info || "ยังไม่มีการประเมิน";
            if (data.history && data.history.length > 0) {
                data.history.forEach(msg => addMessageToDisplay(msg));
            }
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
        }

        function addMessageToDisplay(msg) {
            const role = msg.role || 'user';
            const isAdminSender = msg.sender_type === 'admin';

            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex items-end gap-3';
            if (role === 'user') {
                messageWrapper.classList.add('justify-end');
            }

            const avatar = document.createElement('img');
            avatar.className = 'w-8 h-8 rounded-full object-cover flex-shrink-0';
            if (role === 'user') {
                const currentUserData = usersData[currentUserId];
                avatar.src = currentUserData.pictureUrl || `https://ui-avatars.com/api/?name=${currentUserData.displayName || 'U'}&background=random`;
            } else {
                 avatar.src = 'https://placehold.co/40x40/7c3aed/FFFFFF?text=A'; // Admin/Bot purple avatar
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}`;

            if (isAdminSender) {
                const adminNameSpan = document.createElement('div');
                adminNameSpan.className = 'text-xs text-gray-500 mb-1 px-1 font-semibold';
                adminNameSpan.textContent = msg.sender_name || 'Admin';
                contentWrapper.appendChild(adminNameSpan);
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'max-w-md p-3 rounded-lg break-words whitespace-pre-wrap';
            bubbleDiv.textContent = (msg.parts && msg.parts.length > 0) ? msg.parts[0].text : '(no content)';

            if (role === 'user') {
                bubbleDiv.classList.add('bg-blue-500', 'text-white');
            } else if (isAdminSender) {
                 bubbleDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                 bubbleDiv.classList.add('bg-gray-200', 'text-gray-800');
            }

            const timeDiv = document.createElement('div');
            timeDiv.className = 'text-xs text-gray-400 mt-1 px-1';
            if (msg.timestamp) {
                try {
                    timeDiv.textContent = new Date(msg.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
                } catch (e) { /* do nothing */ }
            }

            contentWrapper.appendChild(bubbleDiv);
            contentWrapper.appendChild(timeDiv);

            if (role === 'user') {
                messageWrapper.appendChild(contentWrapper);
                messageWrapper.appendChild(avatar);
            } else {
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(contentWrapper);
            }
            
            chatHistoryContainer.appendChild(messageWrapper);
        }

        function calculateUnreadCount(user) {
            const history = user.history || [];
            const lastSeen = user.admin_last_seen_timestamp ? new Date(user.admin_last_seen_timestamp) : new Date(0);
            return history.filter(msg => msg.role === 'user' && msg.timestamp && new Date(msg.timestamp) > lastSeen).length;
        }

        adminReplyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = adminMessageInput.value.trim();
            if (!messageText || !currentUserId || !db) return;
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            try {
                await fetch(`/api/inbox/${TENANT_ID}/${currentUserId}/send-admin-message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText })
                });
                adminMessageInput.value = '';
            } catch (error) {
                console.error('Error sending admin reply:', error);
                alert('ไม่สามารถส่งข้อความได้: ' + error.message);
            } finally {
                submitButton.disabled = false;
                adminMessageInput.focus();
            }
        });

        // --- Gemini API Feature Logic ---
        const summarizeBtn = document.getElementById('summarize-btn');
        const draftReplyBtn = document.getElementById('draft-reply-btn');
        const summaryModal = document.getElementById('summary-modal');
        const summaryContent = document.getElementById('summary-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        function showLoader(element) {
            element.innerHTML = `<div class="flex items-center justify-center h-full"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div></div>`;
        }

        summarizeBtn.addEventListener('click', async () => {
            if (!currentUserId) return;
            summaryModal.classList.remove('hidden');
            showLoader(summaryContent);
            try {
                const response = await fetch(`/api/inbox-tools/${TENANT_ID}/${currentUserId}/summarize`, { method: 'POST' });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'ไม่สามารถสรุปบทสนทนาได้');
                }
                const data = await response.json();
                summaryContent.innerHTML = `<p class="text-gray-700 whitespace-pre-wrap">${data.summary}</p>`;
            } catch (error) {
                summaryContent.innerHTML = `<p class="text-red-500 font-semibold">เกิดข้อผิดพลาด:</p><p class="text-red-500">${error.message}</p>`;
            }
        });
        
        draftReplyBtn.addEventListener('click', async () => {
            const keywords = adminMessageInput.value.trim();
            if (!keywords) {
                alert('กรุณาพิมพ์คีย์เวิร์ดเพื่อร่างคำตอบ');
                return;
            }
            if (!currentUserId) return;

            draftReplyBtn.disabled = true;
            draftReplyBtn.classList.add('opacity-50', 'cursor-not-allowed');
            const originalIcon = draftReplyBtn.innerHTML;
            draftReplyBtn.innerHTML = `<div class="loader h-6 w-6 border-2"></div>`;

            try {
                const response = await fetch(`/api/inbox-tools/${TENANT_ID}/${currentUserId}/draft-reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords: keywords })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || 'ไม่สามารถร่างคำตอบได้');
                }
                const data = await response.json();
                adminMessageInput.value = data.draft;
                adminMessageInput.focus();
            } catch (error) {
                alert(error.message);
            } finally {
                draftReplyBtn.disabled = false;
                draftReplyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                draftReplyBtn.innerHTML = originalIcon;
            }
        });

        closeModalBtn.addEventListener('click', () => summaryModal.classList.add('hidden'));
        window.addEventListener('click', (event) => {
            if (event.target == summaryModal) summaryModal.classList.add('hidden');
        });
    </script>
</body>
</html>
